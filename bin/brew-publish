#!/usr/bin/env bash
# Usage: script/brew-publish <name> <version> [-g <gh-project>] [-n] [-f]
#
#    -n    dry-run
#    -f    force
#
# Updates the `<name>.rb` Homebrew formula to `<version>` and sends a pull
# request with the change.
set -e

abort() {
  echo "$1" >&2
  exit 1
}

brew_name="${1?Formula name is required.}"
version="${2?Formula version is required.}"
shift 2

while getopts ":fg:n" opt; do
  case $opt in
  f) force=--force ;;
  g) gh_project="github.com/${OPTARG}" ;;
  n) dryrun=--dry-run; set -x ;;
  :) abort "Option -$OPTARG requires an argument." ;;
  \?) abort "Invalid option: -$OPTARG" ;;
  esac
done

if [ -z "$gh_project" ]; then
  gh_project="$(git remote -v | grep '^origin' | grep -oE 'github.com[:/][^/]+/[^/ ]+' | head -1)"
  gh_project="${gh_project%.git}"
fi

url="https://${gh_project/://}/archive/${version}.tar.gz"

checksum="$(curl -fsSL "$url" | shasum -a 256 -b | awk '{print $1}')"

if [ -z "$checksum" ]; then
  abort "ERROR: calculating the checksum failed for $url"
fi

(
  set -x
  HOMEBREW_DEVELOPER=true brew bump-formula-pr $force $dryrun --url="$url" --sha256="$checksum" "$brew_name"
)
